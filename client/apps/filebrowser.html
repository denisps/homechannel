<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HomeChannel File Browser</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    
    h1 {
      font-size: 2rem;
      color: #667eea;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    /* Connect Form */
    #connect-view {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #555;
    }
    
    input, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      min-height: 100px;
      font-family: monospace;
      font-size: 0.85rem;
    }
    
    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* Browser View */
    #browser-view {
      display: none;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .header h1 {
      margin: 0;
      text-align: left;
    }
    
    .btn-disconnect {
      background: #ff6b6b;
      color: #fff;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    .btn-disconnect:hover {
      background: #ee5a5a;
    }
    
    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    
    .toolbar button {
      background: #667eea;
      color: #fff;
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .toolbar button:hover:not(:disabled) {
      background: #5568d3;
    }
    
    .toolbar svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f5f7fa;
      border-radius: 6px;
      margin-bottom: 1rem;
      overflow-x: auto;
    }
    
    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #667eea;
      cursor: pointer;
      white-space: nowrap;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .breadcrumb-item:hover {
      background: #e8ecf4;
    }
    
    .breadcrumb-item.active {
      color: #333;
      cursor: default;
    }
    
    .breadcrumb-item.active:hover {
      background: transparent;
    }
    
    .breadcrumb-separator {
      color: #999;
    }
    
    /* File List */
    .file-list {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .file-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      gap: 1rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .file-item:last-child {
      border-bottom: none;
    }
    
    .file-item:hover {
      background: #f9fafb;
    }
    
    .file-item.selected {
      background: #eef2ff;
    }
    
    .file-icon {
      width: 24px;
      height: 24px;
    }
    
    .file-icon svg {
      width: 100%;
      height: 100%;
    }
    
    .file-name {
      font-weight: 500;
      color: #333;
    }
    
    .file-size {
      color: #666;
      font-size: 0.9rem;
    }
    
    .file-date {
      color: #999;
      font-size: 0.85rem;
    }
    
    .file-actions {
      display: flex;
      gap: 0.25rem;
    }
    
    .file-actions button {
      padding: 0.25rem 0.5rem;
      background: transparent;
      color: #667eea;
      font-size: 0.8rem;
      border: 1px solid #667eea;
    }
    
    .file-actions button:hover {
      background: #667eea;
      color: #fff;
    }
    
    .file-actions button.delete {
      color: #ff6b6b;
      border-color: #ff6b6b;
    }
    
    .file-actions button.delete:hover {
      background: #ff6b6b;
      color: #fff;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* Status */
    .status {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1rem 1.5rem;
      max-width: 400px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .status.hidden {
      display: none;
    }
    
    .status.error {
      border-left: 4px solid #ff6b6b;
    }
    
    .status.success {
      border-left: 4px solid #51cf66;
    }
    
    .status.info {
      border-left: 4px solid #667eea;
    }
    
    .status-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .status-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }
    
    .status-message {
      flex: 1;
      color: #333;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h2 {
      margin-bottom: 1rem;
      color: #667eea;
    }
    
    .modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }
    
    .modal-actions button {
      padding: 0.6rem 1.2rem;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    /* File Upload */
    #file-input {
      display: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .card {
        padding: 1rem;
      }
      
      .file-item {
        grid-template-columns: auto 1fr;
        gap: 0.5rem;
      }
      
      .file-size,
      .file-date {
        display: none;
      }
      
      .file-actions {
        grid-column: 1 / -1;
        margin-left: 40px;
      }
      
      .status {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Connect View -->
    <div id="connect-view">
      <div class="card">
        <h1>üè† HomeChannel File Browser</h1>
        <form id="connect-form">
          <div class="form-group">
            <label for="coordinator-url">Coordinator URL</label>
            <input 
              type="url" 
              id="coordinator-url" 
              placeholder="https://coordinator.example.com"
              value="http://localhost:3000"
              required
            />
          </div>
          
          <div class="form-group">
            <label for="server-key">Server Public Key</label>
            <textarea 
              id="server-key" 
              placeholder="-----BEGIN PUBLIC KEY-----&#10;...&#10;-----END PUBLIC KEY-----"
              required
            ></textarea>
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <input 
              type="password" 
              id="password" 
              placeholder="Enter your password"
              required
            />
          </div>
          
          <button type="submit" class="btn-primary" id="connect-btn">
            Connect
          </button>
        </form>
      </div>
    </div>
    
    <!-- Browser View -->
    <div id="browser-view">
      <div class="card">
        <div class="header">
          <h1>üìÅ File Browser</h1>
          <button class="btn-disconnect" id="disconnect-btn">Disconnect</button>
        </div>
        
        <div class="toolbar">
          <button id="back-btn" title="Go to parent directory">
            <svg viewBox="0 0 24 24"><use href="#icon-back"/></svg>
            Back
          </button>
          <button id="new-folder-btn" title="Create new folder">
            <svg viewBox="0 0 24 24"><use href="#icon-new-folder"/></svg>
            New Folder
          </button>
          <button id="upload-btn" title="Upload files">
            <svg viewBox="0 0 24 24"><use href="#icon-upload"/></svg>
            Upload
          </button>
        </div>
        
        <div class="breadcrumb" id="breadcrumb"></div>
        
        <div class="file-list" id="file-list"></div>
      </div>
    </div>
  </div>
  
  <!-- Status Toast -->
  <div class="status hidden" id="status">
    <div class="status-content">
      <div class="status-icon"></div>
      <div class="status-message"></div>
    </div>
  </div>
  
  <!-- Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal"></div>
  </div>
  
  <!-- Hidden File Input -->
  <input type="file" id="file-input" multiple />
  
  <!-- SVG Icons -->
  <svg style="display: none">
    <defs>
      <symbol id="icon-folder" viewBox="0 0 24 24">
        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
      </symbol>
      
      <symbol id="icon-file" viewBox="0 0 24 24">
        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
      </symbol>
      
      <symbol id="icon-back" viewBox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </symbol>
      
      <symbol id="icon-new-folder" viewBox="0 0 24 24">
        <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 8h-3v3h-2v-3h-3v-2h3V9h2v3h3v2z"/>
      </symbol>
      
      <symbol id="icon-upload" viewBox="0 0 24 24">
        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
      </symbol>
      
      <symbol id="icon-download" viewBox="0 0 24 24">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
      </symbol>
      
      <symbol id="icon-delete" viewBox="0 0 24 24">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
      </symbol>
      
      <symbol id="icon-spinner" viewBox="0 0 24 24">
        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
      </symbol>
      
      <symbol id="icon-error" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
      </symbol>
      
      <symbol id="icon-success" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </symbol>
      
      <symbol id="icon-info" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
      </symbol>
    </defs>
  </svg>
  
  <script src="client.js"></script>
  <script>
    // Get Client from window object (UMD exports to HomeChannelClient)
    const { Client } = window.HomeChannelClient;
    
    // App State
    const state = {
      client: null,
      currentPath: '',
      files: [],
      pendingRequests: new Map(),
      nextRequestId: 1
    };
    
    // DOM Elements
    const connectView = document.getElementById('connect-view');
    const browserView = document.getElementById('browser-view');
    const connectForm = document.getElementById('connect-form');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const coordinatorUrlInput = document.getElementById('coordinator-url');
    const serverKeyInput = document.getElementById('server-key');
    const passwordInput = document.getElementById('password');
    const breadcrumb = document.getElementById('breadcrumb');
    const fileList = document.getElementById('file-list');
    const backBtn = document.getElementById('back-btn');
    const newFolderBtn = document.getElementById('new-folder-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');
    const statusEl = document.getElementById('status');
    const modalOverlay = document.getElementById('modal-overlay');
    const modal = document.getElementById('modal');
    
    // Utility Functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 86400000) { // Less than 24 hours
        return date.toLocaleTimeString();
      } else if (diff < 604800000) { // Less than 7 days
        return date.toLocaleDateString(undefined, { weekday: 'short', hour: '2-digit', minute: '2-digit' });
      } else {
        return date.toLocaleDateString();
      }
    }
    
    function showStatus(message, type = 'info') {
      const statusIcon = statusEl.querySelector('.status-icon');
      const statusMessage = statusEl.querySelector('.status-message');
      
      statusEl.className = `status ${type}`;
      statusMessage.textContent = message;
      
      const iconMap = {
        error: 'icon-error',
        success: 'icon-success',
        info: 'icon-info'
      };
      
      statusIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="${
        type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#667eea'
      }"><use href="#${iconMap[type]}"/></svg>`;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusEl.classList.add('hidden');
      }, 5000);
    }
    
    function showModal(content) {
      modal.innerHTML = content;
      modalOverlay.classList.add('active');
    }
    
    function hideModal() {
      modalOverlay.classList.remove('active');
      modal.innerHTML = '';
    }
    
    // Click outside modal to close
    modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) {
        hideModal();
      }
    });
    
    // Client Communication
    function generateRequestId() {
      return `req_${state.nextRequestId++}_${Date.now()}`;
    }
    
    function sendRequest(service, operation, params = {}) {
      return new Promise((resolve, reject) => {
        const requestId = generateRequestId();
        
        state.pendingRequests.set(requestId, { resolve, reject });
        
        state.client.send({
          requestId,
          service,
          operation,
          params
        });
        
        // Timeout after 30 seconds
        setTimeout(() => {
          if (state.pendingRequests.has(requestId)) {
            state.pendingRequests.delete(requestId);
            reject(new Error('Request timeout'));
          }
        }, 30000);
      });
    }
    
    function handleMessage(message) {
      try {
        const data = JSON.parse(message);
        
        if (data.requestId && state.pendingRequests.has(data.requestId)) {
          const { resolve, reject } = state.pendingRequests.get(data.requestId);
          state.pendingRequests.delete(data.requestId);
          
          if (data.success) {
            resolve(data.result);
          } else {
            reject(new Error(data.error || 'Unknown error'));
          }
        }
      } catch (error) {
        console.error('Error handling message:', error);
      }
    }
    
    // File Operations
    async function listDirectory(path) {
      try {
        const result = await sendRequest('files', 'listDirectory', { path });
        state.currentPath = path;
        state.files = result.items;
        renderBreadcrumb();
        renderFileList();
      } catch (error) {
        showStatus(`Failed to list directory: ${error.message}`, 'error');
      }
    }
    
    async function createFolder(name) {
      try {
        const newPath = state.currentPath ? `${state.currentPath}/${name}` : name;
        await sendRequest('files', 'createDirectory', { path: newPath });
        showStatus('Folder created successfully', 'success');
        await listDirectory(state.currentPath);
      } catch (error) {
        showStatus(`Failed to create folder: ${error.message}`, 'error');
      }
    }
    
    async function deleteItem(path, type) {
      try {
        const operation = type === 'directory' ? 'deleteDirectory' : 'deleteFile';
        await sendRequest('files', operation, { path });
        showStatus(`${type === 'directory' ? 'Folder' : 'File'} deleted successfully`, 'success');
        await listDirectory(state.currentPath);
      } catch (error) {
        showStatus(`Failed to delete: ${error.message}`, 'error');
      }
    }
    
    async function uploadFile(file) {
      try {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const content = e.target.result.split(',')[1]; // Get base64 content
            const filePath = state.currentPath ? `${state.currentPath}/${file.name}` : file.name;
            
            await sendRequest('files', 'writeFile', {
              path: filePath,
              content,
              encoding: 'base64'
            });
            
            showStatus(`File uploaded: ${file.name}`, 'success');
            await listDirectory(state.currentPath);
          } catch (error) {
            showStatus(`Failed to upload ${file.name}: ${error.message}`, 'error');
          }
        };
        
        reader.onerror = () => {
          showStatus(`Failed to read file: ${file.name}`, 'error');
        };
        
        reader.readAsDataURL(file);
      } catch (error) {
        showStatus(`Upload error: ${error.message}`, 'error');
      }
    }
    
    async function downloadFile(path, name) {
      try {
        const result = await sendRequest('files', 'readFile', { path });
        
        // Convert content to blob
        let blob;
        if (result.encoding === 'base64') {
          const binaryString = atob(result.content);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          blob = new Blob([bytes], { type: result.mimeType || 'application/octet-stream' });
        } else {
          blob = new Blob([result.content], { type: result.mimeType || 'text/plain' });
        }
        
        // Trigger download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus(`Downloaded: ${name}`, 'success');
      } catch (error) {
        showStatus(`Failed to download: ${error.message}`, 'error');
      }
    }
    
    // Render Functions
    function renderBreadcrumb() {
      const parts = state.currentPath ? state.currentPath.split('/').filter(p => p) : [];
      
      let html = `
        <div class="breadcrumb-item ${parts.length === 0 ? 'active' : ''}" data-path="">
          üè† Home
        </div>
      `;
      
      parts.forEach((part, index) => {
        const path = parts.slice(0, index + 1).join('/');
        const isLast = index === parts.length - 1;
        
        html += `
          <span class="breadcrumb-separator">/</span>
          <div class="breadcrumb-item ${isLast ? 'active' : ''}" data-path="${escapeHtml(path)}">
            ${escapeHtml(part)}
          </div>
        `;
      });
      
      breadcrumb.innerHTML = html;
      
      // Add click handlers
      breadcrumb.querySelectorAll('.breadcrumb-item:not(.active)').forEach(item => {
        item.addEventListener('click', () => {
          listDirectory(item.dataset.path);
        });
      });
      
      // Update back button state
      backBtn.disabled = parts.length === 0;
    }
    
    function renderFileList() {
      if (state.files.length === 0) {
        fileList.innerHTML = `
          <div class="empty-state">
            <svg fill="#999" viewBox="0 0 24 24"><use href="#icon-folder"/></svg>
            <p>This folder is empty</p>
          </div>
        `;
        return;
      }
      
      // Sort: directories first, then files, alphabetically
      const sorted = [...state.files].sort((a, b) => {
        if (a.type !== b.type) {
          return a.type === 'directory' ? -1 : 1;
        }
        return a.name.localeCompare(b.name);
      });
      
      let html = '';
      sorted.forEach(file => {
        const icon = file.type === 'directory' ? 'icon-folder' : 'icon-file';
        const fullPath = state.currentPath ? `${state.currentPath}/${file.name}` : file.name;
        
        html += `
          <div class="file-item" data-path="${escapeHtml(fullPath)}" data-type="${file.type}" data-name="${escapeHtml(file.name)}">
            <div class="file-icon">
              <svg fill="${file.type === 'directory' ? '#FFA500' : '#667eea'}" viewBox="0 0 24 24">
                <use href="#${icon}"/>
              </svg>
            </div>
            <div class="file-name">${escapeHtml(file.name)}</div>
            <div class="file-size">${file.type === 'file' ? formatFileSize(file.size) : '‚Äî'}</div>
            <div class="file-date">${formatDate(file.modified)}</div>
            <div class="file-actions">
              ${file.type === 'file' ? `
                <button class="download" title="Download">
                  <svg viewBox="0 0 24 24" fill="currentColor"><use href="#icon-download"/></svg>
                </button>
              ` : ''}
              <button class="delete" title="Delete">
                <svg viewBox="0 0 24 24" fill="currentColor"><use href="#icon-delete"/></svg>
              </button>
            </div>
          </div>
        `;
      });
      
      fileList.innerHTML = html;
      
      // Add event listeners
      fileList.querySelectorAll('.file-item').forEach(item => {
        const path = item.dataset.path;
        const type = item.dataset.type;
        const name = item.dataset.name;
        
        // Double-click to open folder
        item.addEventListener('dblclick', () => {
          if (type === 'directory') {
            listDirectory(path);
          }
        });
        
        // Download button
        const downloadBtn = item.querySelector('.download');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            downloadFile(path, name);
          });
        }
        
        // Delete button
        const deleteBtn = item.querySelector('.delete');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          confirmDelete(path, name, type);
        });
      });
    }
    
    function confirmDelete(path, name, type) {
      showModal(`
        <h2>Delete ${type === 'directory' ? 'Folder' : 'File'}?</h2>
        <p>Are you sure you want to delete <strong>${escapeHtml(name)}</strong>?</p>
        ${type === 'directory' ? '<p style="color: #ff6b6b; margin-top: 0.5rem;">Note: Folder must be empty to delete.</p>' : ''}
        <div class="modal-actions">
          <button class="btn-secondary" onclick="window.hideModal()">Cancel</button>
          <button class="btn-primary" style="background: #ff6b6b;" id="confirm-delete">Delete</button>
        </div>
      `);
      
      document.getElementById('confirm-delete').addEventListener('click', async () => {
        hideModal();
        await deleteItem(path, type);
      });
    }
    
    // Event Handlers
    connectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const coordinatorUrl = coordinatorUrlInput.value.trim();
      const serverKey = serverKeyInput.value.trim();
      const password = passwordInput.value;
      
      try {
        connectBtn.disabled = true;
        connectBtn.textContent = 'Connecting...';
        
        state.client = new Client(coordinatorUrl);
        
        state.client.on('connected', () => {
          connectView.style.display = 'none';
          browserView.style.display = 'block';
          showStatus('Connected successfully', 'success');
          listDirectory('');
        });
        
        state.client.on('message', handleMessage);
        
        state.client.on('disconnected', () => {
          showStatus('Disconnected from server', 'info');
          browserView.style.display = 'none';
          connectView.style.display = 'block';
          connectBtn.disabled = false;
          connectBtn.textContent = 'Connect';
        });
        
        state.client.on('error', (error) => {
          showStatus(`Error: ${error.message}`, 'error');
        });
        
        await state.client.connect(serverKey, password);
        
      } catch (error) {
        showStatus(`Connection failed: ${error.message}`, 'error');
        connectBtn.disabled = false;
        connectBtn.textContent = 'Connect';
      }
    });
    
    disconnectBtn.addEventListener('click', () => {
      if (state.client) {
        state.client.disconnect();
      }
    });
    
    backBtn.addEventListener('click', () => {
      const parts = state.currentPath.split('/').filter(p => p);
      parts.pop();
      listDirectory(parts.join('/'));
    });
    
    newFolderBtn.addEventListener('click', () => {
      showModal(`
        <h2>Create New Folder</h2>
        <div class="form-group">
          <label for="folder-name">Folder Name</label>
          <input type="text" id="folder-name" placeholder="New Folder" required />
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" onclick="window.hideModal()">Cancel</button>
          <button class="btn-primary" id="create-folder">Create</button>
        </div>
      `);
      
      const folderNameInput = document.getElementById('folder-name');
      const createBtn = document.getElementById('create-folder');
      
      createBtn.addEventListener('click', async () => {
        const name = folderNameInput.value.trim();
        if (name) {
          hideModal();
          await createFolder(name);
        }
      });
      
      folderNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          createBtn.click();
        }
      });
      
      setTimeout(() => folderNameInput.focus(), 100);
    });
    
    uploadBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      if (files.length === 0) return;
      
      showStatus(`Uploading ${files.length} file(s)...`, 'info');
      
      for (const file of files) {
        await uploadFile(file);
      }
      
      fileInput.value = '';
    });
    
    // Make hideModal globally accessible for modal buttons
    window.hideModal = hideModal;
  </script>
</body>
</html>
